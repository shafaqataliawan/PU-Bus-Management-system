<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS + Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- customize css  -->
    <link rel="stylesheet" href="css/dashboard.css" />
  
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="pu-logo text-center mb-4 mt-3">
        <img src="https://www.pu.edu.pk/images/logopu.png" alt="Logo" />
        <h4 class="text-center mt-2">PUBMS</h4>
      </div>
      <a href="dashboard.html"
        ><i class="bi bi-speedometer2 me-2"></i> Dashboard</a
      >
      
      <a href="drivers.html" ><i class="bi bi-person-badge me-2"></i> Driver</a>
      <a href="ad-routes.html"
        ><i class="bi bi-signpost-split me-2"></i> Routes</a
      >
      <a href="ad-bus.html"><i class="bi bi-bus-front me-2"></i> Bus</a>
      <a href="admin-tracking.html"><i class="bi bi-geo-alt me-2"></i> Live Tracking</a>
      <a href="settings.html"><i class="bi bi-gear me-2"></i> Setting</a>
      <a href="logout.html"
        ><i class="bi bi-box-arrow-right me-2"></i> Logout</a
      >
    </div>
    <!-- Sidebar Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand navbar-bg navbar-custom" id="navbar">
      <div class="container-fluid">
        <!-- Mobile: Hamburger + Dark Mode Icon together -->
        <div class="d-flex align-items-center d-lg-none me-2">
          <button class="btn btn-outline-secondary btn-sm me-2" id="sidebarToggle" type="button">
            <i class="bi bi-list"></i>
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="toggleDarkMode()">
            <i class="bi bi-moon"></i>
          </button>
        </div>
        <!-- Desktop: Only Dark Mode Icon at start -->
        <button class="btn btn-outline-secondary btn-sm d-none d-lg-inline me-2" onclick="toggleDarkMode()">
          <i class="bi bi-moon"></i>
        </button>
        <div class="d-flex ms-auto align-items-center gap-3">
          <a
            class="nav-link"
            href="#"
            data-bs-toggle="modal"
            data-bs-target="#announcementModal"
          >
            <i class="bi bi-megaphone-fill fs-4 text-white"></i>
          </a>
          <div class="dropdown">
            <a
              class="nav-link dropdown-toggle text-white"
              href="#"
              id="profileDropdown"
              role="button"
              data-bs-toggle="dropdown"
            >
              <i class="bi bi-person-circle fs-4 text-white"></i>
            </a>
            <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="profileDropdown"
              id="profileDropdownMenu"
            >
              <li class="px-3 py-2">
                <span class="fw-bold" id="dropdownUserEmail">user@example.com</span>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="/profile.html">View Profile</a></li>
              <li><a class="dropdown-item" href="/settings.html">Settings</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="/logout.html">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Announcement Modal -->
    <div
      class="modal fade"
      id="announcementModal"
      tabindex="-1"
      aria-labelledby="announcementModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content" id="announcementModalContent">
          <div class="modal-header">
            <h5 class="modal-title annouc-heading">üì¢ Create Announcement</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <label for="announcementTitle" class="form-label">Title</label>
            <input
              type="text"
              class="form-control mb-2"
              id="announcementTitle"
              placeholder="Title"
            />
            <label for="announcementDescription" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control mb-2"
              id="announcementDescription"
              rows="3"
              placeholder="Description"
            ></textarea>
            <label for="announcementDate" class="form-label">Date</label>
            <input
              type="date"
              class="form-control mb-2"
              id="announcementDate"
              placeholder="Date"
            />
            <label for="announcementExpiry" class="form-label"
              >Expiry Date</label
            >
            <input
              type="date"
              class="form-control mb-2"
              id="announcementExpiry"
              placeholder="Expiry Date"
            />
            <button class="btn submit-btn w-100" onclick="postAnnouncement()">
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <h3 class="admin-heading">Admin Dashboard</h3>
      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <div class="card card-summary shadow-sm bg-success text-white">
            <div class="card-body">
              <i class="bi bi-people-fill"></i>
              <div>
                <h6>Students</h6>
                <h5 id="studentCount">5000</h5>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-summary shadow-sm bg-primary text-white">
            <div class="card-body">
              <i class="bi bi-bus-front me-2"></i>
              <div>
                <h6>Bus</h6>
                <h5 id="busCount">250</h5>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-summary shadow-sm bg-dark text-white">
            <div class="card-body">
              <i class="bi bi-person-badge"></i>
              <div>
                <h6>Drivers</h6>
                <h5 id="driverCount">75</h5>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-summary shadow-sm bg-warning text-dark">
            <div class="card-body">
              <i class="bi bi-signpost-2"></i>
              <div>
                <h6>Routes</h6>
                <h5 id="routeCount">18</h5>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Students Table Section -->
      <div class="container mt-5">
        <h4 class="text-center mb-4">üë®‚Äçüéì Student Registrations</h4>
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="studentSearch" placeholder="Search students by name, email, route...">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle text-center shadow-sm">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Department</th>
                <th>Program</th>
                <th>Batch</th>
                <th>Semester</th>
                <th>Gender</th>
                <th>Address</th>
                <th>Route</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="students-table-body">
              <!-- Data will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Driver Table Section -->
      <div class="container mt-5">
        <h4 class="text-center mb-4">üöå Driver Management</h4>
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="driverSearch" placeholder="Search drivers by name, email, bus number...">
          </div>
        </div>
        <div class="table-responsive">
          <table
            class="table table-bordered table-hover align-middle text-center shadow-sm"
          >
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Profile</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Bus</th>
                <th>Route</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="driver-table-body">
              <!-- Data will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Bus Table Section -->
      <div class="container mt-5" id="bus-table-section">
        <h4 class="text-center mb-4">üöå Bus Management</h4>
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="busSearch" placeholder="Search buses by number, route...">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle text-center shadow-sm">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Bus Number</th>
                <th>Route</th>
                <th>Driver</th>
                <th>Capacity</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bus-table-body">
              <!-- Data will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Route Table Section -->
      <div class="container mt-5">
        <h4 class="text-center mb-4">üöè Route Management</h4>
        <!-- Add Route Form Start -->
        <!-- (REMOVED) -->
        <!-- Add Route Form End -->
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="routeSearch" placeholder="Search routes by name, location, bus number...">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle text-center shadow-sm">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Route</th>
                <th>From</th>
                <th>To</th>
                <th>Distance</th>
                <th>Time</th>
                <th>Bus Number</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="routes-table-body">
              <!-- Data will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Bus Modal -->
    <div class="modal fade" id="editBusModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Bus Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editBusId">
            <div class="mb-3">
              <label class="form-label">Bus Number</label>
              <input type="text" class="form-control" id="editBusNumber" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Capacity</label>
              <input type="number" class="form-control" id="editCapacity" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Driver</label>
              <input type="text" class="form-control" id="editDriver" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Start Point</label>
              <input type="text" class="form-control" id="editStartPoint" required>
            </div>
            <div class="mb-3">
              <label class="form-label">End Point</label>
              <input type="text" class="form-control" id="editEndPoint" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="updateBus()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Driver Modal -->
    <div class="modal fade" id="editDriverModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Driver Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editDriverId">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="editDriverName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="editDriverEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="text" class="form-control" id="editDriverPhone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Bus</label>
              <input type="text" class="form-control" id="editDriverBus" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Route</label>
              <input type="text" class="form-control" id="editDriverRoute" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-control" id="editDriverStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="updateDriver()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Route Modal -->
    <div class="modal fade" id="editRouteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Route Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editRouteId">
            <div class="mb-3">
              <label class="form-label">Route Name</label>
              <input type="text" class="form-control" id="editRouteName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Route Number</label>
              <input type="text" class="form-control" id="editRouteNumber" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Bus Name</label>
              <input type="text" class="form-control" id="editBusName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Driver Name</label>
              <input type="text" class="form-control" id="editDriverName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Start Point</label>
              <input type="text" class="form-control" id="editStartPoint" required>
            </div>
            <div class="mb-3">
              <label class="form-label">End Point</label>
              <input type="text" class="form-control" id="editEndPoint" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="updateRoute()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Edit Route Modal -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Add authentication check at the start
      document.addEventListener("DOMContentLoaded", function() {
        // Check if user is authenticated
        const token = localStorage.getItem('authToken');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        // Check if user is admin
        const role = localStorage.getItem('userRole');
        if (role !== 'admin') {
          window.location.href = '/index.html';
          return;
        }

        // Rest of your existing initialization code
        displayUserEmail();
        loadStudents();
        loadDrivers();
        loadBusData();
        loadRoutes();
      });

      // Toggle Dark Mode
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        document.getElementById("sidebar").classList.toggle("dark-mode");
        document.getElementById("navbar").classList.toggle("dark-mode");
        document
          .getElementById("profileDropdownMenu")
          .classList.toggle("dark-mode");
        document
          .getElementById("announcementModalContent")
          .classList.toggle("dark-mode");
      }

      // Display logged-in user's email
      function displayUserEmail() {
        // Get email from localStorage (assuming it was stored during login)
        const userEmail = localStorage.getItem('userEmail') || 'user@example.com';
        document.getElementById('dropdownUserEmail').textContent = userEmail;
      }

      // Store the original data for each table
      let allDrivers = [];
      let allBuses = [];
      let allRoutes = [];

      // Load Drivers Data
      async function loadDrivers() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch("http://localhost:5000/api/drivers", {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (res.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
            return;
          }
          
          const drivers = await res.json();
          allDrivers = drivers; // Store all drivers
          renderDrivers(drivers); // Initial render
          
          // Update driver count
          document.getElementById("driverCount").textContent = drivers.length;
        } catch (err) {
          console.error("Error loading drivers:", err);
        }
      }

      // Load Students Data
      async function loadStudents() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch('/api/student/all', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (res.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
            return;
          }
          
          const students = await res.json();
          
          // Update student count
          document.getElementById("studentCount").textContent = students.length;
        } catch (err) {
          console.error("Error loading students:", err);
        }
      }

      // Load Bus Data
      async function loadBusData() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch('/api/bus/all', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (res.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
            return;
          }
          
          const buses = await res.json();
          allBuses = buses; // Store all buses
          renderBuses(buses); // Initial render
          
          // Update bus count
          document.getElementById('busCount').textContent = buses.length;
        } catch (error) {
          console.error("Error loading bus data:", error);
          alert("Failed to load bus data");
        }
      }

      // Load Routes Data
      async function loadRoutes() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch("http://localhost:5000/api/routes", {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (res.status === 401) {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
            return;
          }
          
          const routes = await res.json();
          allRoutes = routes; // Store all routes
          renderRoutes(routes); // Initial render
          
          // Update route count
          document.getElementById("routeCount").textContent = routes.length;
        } catch (err) {
          console.error("Error loading routes:", err);
        }
      }

      // Render Routes Table
      function renderRoutes(routes) {
        const tbody = document.getElementById("routes-table-body");
        tbody.innerHTML = "";
        
        routes.forEach((r, i) => {
          tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${r.routeName}</td>
            <td>${r.startPoint}</td>
            <td>${r.endPoint}</td>
            <td>${r.distance} km</td>
            <td>${r.estimatedTime}</td>
            <td>${r.busNumber || "N/A"}</td>
            <td><span class="badge bg-${r.status === "Active" ? "success" : "secondary"}">${r.status}</span></td>
            <td>
              <div class="dropdown action-dropdown">
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" onclick="editRoute('${r._id}')">
                    <i class="bi bi-pencil-square"></i> Edit
                  </a></li>
                  <li><a class="dropdown-item" onclick="deleteRoute('${r._id}')">
                    <i class="bi bi-trash"></i> Delete
                  </a></li>
                  <li><a class="dropdown-item" onclick="toggleRoute('${r._id}')">
                    <i class="bi bi-toggle-on"></i> Toggle Status
                  </a></li>
                </ul>
              </div>
            </td>
          </tr>`;
        });
      }

      // Edit Route
      function editRoute(id) {
        window.location.href = `ad-routes.html?edit=${id}`;
      }

      // Delete Route
      function deleteRoute(id) {
        if (confirm("Are you sure you want to delete this route?")) {
          const token = localStorage.getItem('authToken');
          fetch(`http://localhost:5000/api/routes/delete/${id}`, {
            method: "DELETE",
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
            .then(() => loadRoutes())
            .catch(console.error);
        }
      }

      // Toggle Route Status
      function toggleRoute(id) {
        const token = localStorage.getItem('authToken');
        fetch(`http://localhost:5000/api/routes/toggle/${id}`, {
          method: "PATCH",
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
          .then(() => loadRoutes())
          .catch(console.error);
      }

      // Announcement Function
      async function postAnnouncement() {
        const title = document.getElementById("announcementTitle").value;
        const description = document.getElementById("announcementDescription").value;
        const date = document.getElementById("announcementDate").value;
        const expiry = document.getElementById("announcementExpiry").value;

        if (!title || !description || !date || !expiry) {
          alert("All fields are required!");
          return;
        }

        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch("http://localhost:5000/api/announcements/add", {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ title, description, date, expiry }),
          });

          if (res.ok) {
            alert("Announcement posted successfully!");
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("announcementModal")
            );
            modal.hide();
            document.getElementById("announcementTitle").value = "";
            document.getElementById("announcementDescription").value = "";
            document.getElementById("announcementDate").value = "";
            document.getElementById("announcementExpiry").value = "";
          } else {
            alert("Failed to post announcement.");
          }
        } catch (error) {
          console.error(error);
          alert("Server error.");
        }
      }

      // Search functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Driver search
        document.getElementById('driverSearch').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          const filteredDrivers = allDrivers.filter(driver => 
            driver.name?.toLowerCase().includes(searchTerm) ||
            driver.email?.toLowerCase().includes(searchTerm) ||
            driver.phone?.toLowerCase().includes(searchTerm) ||
            driver.busNumber?.toLowerCase().includes(searchTerm) ||
            driver.route?.toLowerCase().includes(searchTerm)
          );
          renderDrivers(filteredDrivers);
        });

        // Bus search
        document.getElementById('busSearch').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          const filteredBuses = allBuses.filter(bus => 
            bus.busNumber?.toLowerCase().includes(searchTerm) ||
            bus.route?.toLowerCase().includes(searchTerm)
          );
          renderBuses(filteredBuses);
        });

        // Route search
        document.getElementById('routeSearch').addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          const filteredRoutes = allRoutes.filter(route => 
            route.routeName?.toLowerCase().includes(searchTerm) ||
            route.startPoint?.toLowerCase().includes(searchTerm) ||
            route.endPoint?.toLowerCase().includes(searchTerm) ||
            route.busNumber?.toLowerCase().includes(searchTerm)
          );
          renderRoutes(filteredRoutes);
        });
      });

      // Sidebar toggle for mobile
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebarToggle = document.getElementById('sidebarToggle');
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
          sidebar.classList.toggle('sidebar-open');
          sidebarOverlay.classList.toggle('active');
        });
      }
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', function() {
          sidebar.classList.remove('sidebar-open');
          sidebarOverlay.classList.remove('active');
        });
      }
    </script>

    <!-- Custom JS -->
    <script src="/js/dashboard.js"></script>
  </body>
</html>